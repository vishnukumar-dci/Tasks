<!DOCTYPE html>
<html>
<head>
  <title>file Upload</title>
</head>
<body>
  <!-- <h2>Enter the userId</h1>
  <input type="text" id="userId"> -->
  <h2>Select Image to Upload</h2>
  <input type="file" id="fileInput" accept="image/*" />
  <br><br>
  <button onclick="uploadImage()">Upload</button>

  <script>
    async function uploadImage() {
      const fileInput = document.getElementById('fileInput');
      // const Id = document.getElementById('userId')

      // if(Id.value.length === 0){
      //   alert('Please enter a userId')
      //   return
      // }

      if (!fileInput.files.length) {
        alert('Please select a file');
        return;
      }

      const file = fileInput.files[0];
      const chunkSize = 1 * 1024 * 1024; 
      const uploadId = Date.now().toString();

      const base64 = await readFileAsBase64(file);
      const base64Data = base64.split(',')[1]; 

      const totalChunks = Math.ceil(base64Data.length / chunkSize);
      const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFydW5AZ21haWwuY29tIiwiaWF0IjoxNzU0OTY0MTIyLCJleHAiOjE3NTQ5Njc3MjJ9.omgq6ifwFfXYUyhQHNhMiox_eleOVrhr8TQ4mlaw0N4"
      
      for (let i = 0; i < totalChunks; i++) {
        const chunk = base64Data.slice(i * chunkSize, (i + 1) * chunkSize);

        const res = await fetch('http://localhost:8088/user/chunk', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            "Authorization":`Bearer ${token}`
          },
          body: JSON.stringify({
            uploadId: uploadId,
            chunkIndex: i,
            data: chunk
          })
        });


        if (!res.ok) {
          alert(res.statusText);
          return;
        }
      }

      // Merge chunks after all are uploaded
      const mergeRes = await fetch('http://localhost:8088/user/merge', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization':`Bearer ${token}`
        },
        body: JSON.stringify({
          uploadId: uploadId,
          contentType: file.type
        })
      });

      if (mergeRes.ok) {
        alert('Image uploaded and saved to MongoDB!');
      } else {
        console.log(mergeRes)
        alert('Failed to merge chunks.');
      }
    }

    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file); 
      });
    }
  </script>
</body>
</html>
